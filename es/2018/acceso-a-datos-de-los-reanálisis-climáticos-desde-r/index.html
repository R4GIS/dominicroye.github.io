<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.47.1" />
  <meta name="author" content="Dr. Dominic Royé">

  
  
  
  
    
  
  <meta name="description" content="En este post enseñaré cómo podemos descargar y trabajar directamente con datos provinientes de los reanálisis climáticos en R. Se trata de sistemas de asimilación de datos que combinan modelos de pronóstico meteorológico y observaciones de distintas fuentes de forma objetiva con el fin de sintetizar el estado actual y la evolución de multiples variables de la atmósfera, la superficie de la tierra y los océanos.">

  
  <link rel="alternate" hreflang="en-us" href="https://dominicroye.github.io/es/2018/acceso-a-datos-de-los-rean%C3%A1lisis-clim%C3%A1ticos-desde-r/">

  


  

  
  
  
  <meta name="theme-color" content="#0095eb">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css" crossorigin="anonymous">
      
    

    

    

  

  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Playfair&#43;Display:400,700%7cFauna&#43;One">
  

  <link rel="stylesheet" href="/es/styles.css">
  
  <link rel="stylesheet" href="/css/override.css">
  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-27463794-2', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  
  <link rel="alternate" href="https://dominicroye.github.io/index.xml" type="application/rss+xml" title="Dominic Royé">
  <link rel="feed" href="https://dominicroye.github.io/index.xml" type="application/rss+xml" title="Dominic Royé">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://dominicroye.github.io/es/2018/acceso-a-datos-de-los-rean%C3%A1lisis-clim%C3%A1ticos-desde-r/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@dr_xeo">
  <meta property="twitter:creator" content="@dr_xeo">
  
  <meta property="og:site_name" content="Dominic Royé">
  <meta property="og:url" content="https://dominicroye.github.io/es/2018/acceso-a-datos-de-los-rean%C3%A1lisis-clim%C3%A1ticos-desde-r/">
  <meta property="og:title" content="Acceso a datos de los reanálisis climáticos desde R | Dominic Royé">
  <meta property="og:description" content="En este post enseñaré cómo podemos descargar y trabajar directamente con datos provinientes de los reanálisis climáticos en R. Se trata de sistemas de asimilación de datos que combinan modelos de pronóstico meteorológico y observaciones de distintas fuentes de forma objetiva con el fin de sintetizar el estado actual y la evolución de multiples variables de la atmósfera, la superficie de la tierra y los océanos."><meta property="og:image" content="img/temp850_2016.png">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2018-09-15T10:59:44&#43;01:00">
  
  <meta property="article:modified_time" content="2018-09-15T10:59:44&#43;01:00">
  

  

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#0095eb",
          "text": "#fff"
        },
        "button": {
          "background": "#fff",
          "text": "#0095eb"
        }
      },
      "theme": "classic",
      "content": {
        "message": "Este sitio web utiliza cookies para garantizarle una mejor experiencia.",
        "dismiss": "Entendido!",
        "link": "Más información",
        "href": "https://cookies.insites.com"
      }
    })});
</script>


  
          <meta property="og:type" content="website" />
          <meta property="og:title" content="Acceso a datos de los reanálisis climáticos desde R &middot; Dominic Royé"/>
          <meta property="og:description" content="Blog of Dominic Royé - geographic data | understanding the world"/>
          <meta property="og:site_name" content="Dominic Royé"/>
          <meta property="og:url" content="https://dominicroye.github.io/es/2018/acceso-a-datos-de-los-rean%C3%A1lisis-clim%C3%A1ticos-desde-r/"/>
          <meta property="og:locale" content="en">
            
          <meta property="og:image" content="https://dominicroye.github.io"/>
          <meta property="og:image:secure_url" content=""/>
          
          <meta property="og:type" content="website"/>

  <title>Acceso a datos de los reanálisis climáticos desde R | Dominic Royé</title>

</head>
<body id="top" data-spy="scroll" data-target="#toc" data-offset="71" >

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Barra de navegación</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="/es/"><div style="position:relative;float:left">Dominic Royé<img src="/img/portrait.jpg" alt="Dominic Royé" style="float: left;"></div></a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      
      <ul class="nav navbar-nav navbar-right">
        

        
        
        
        
        

        <li class="nav-item">
          <a href="/es/#">
            
            <span>inicio</span>
            
          </a>
        </li>

        
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/es/#posts">
            
            <span>blog</span>
            
          </a>
        </li>

        
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/es/#publications_selected">
            
            <span>publicaciones</span>
            
          </a>
        </li>

        
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/es/#about">
            
            <span>mí</span>
            
          </a>
        </li>

        
        
      

      
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  
<div class="article-header">
  
  
    <img src="/img/temp850_2016.png" class="article-banner" itemprop="image">
  

  
</div>



  <div class="article-container">
    <h1 itemprop="name">Acceso a datos de los reanálisis climáticos desde R</h1>

    

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>
  

  <span class="article-date">
    
    <meta content="2018-09-15 10:59:44 &#43;0100 BST" itemprop="datePublished">
    <time datetime="2018-09-15 10:59:44 &#43;0100 BST" itemprop="dateModified">
      2018-09-15
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Dr. Dominic Royé">
  </span>

  

  
  
  <span class="middot-divider"></span>
  <a href="https://dominicroye.github.io/es/2018/acceso-a-datos-de-los-rean%C3%A1lisis-clim%C3%A1ticos-desde-r/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fa fa-folder"></i>
    
    <a href="https://dominicroye.github.io/es/categories/r/">R</a>, 
    
    <a href="https://dominicroye.github.io/es/categories/rintermedio/">R:intermedio</a>
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Acceso%20a%20datos%20de%20los%20rean%c3%a1lisis%20clim%c3%a1ticos%20desde%20R&amp;url=https://dominicroye.github.iohttps%3a%2f%2fdominicroye.github.io%2fes%2f2018%2facceso-a-datos-de-los-rean%25C3%25A1lisis-clim%25C3%25A1ticos-desde-r%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-twitter"></i>
      </a>
    </li>



    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https://dominicroye.github.iohttps%3a%2f%2fdominicroye.github.io%2fes%2f2018%2facceso-a-datos-de-los-rean%25C3%25A1lisis-clim%25C3%25A1ticos-desde-r%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://dominicroye.github.iohttps%3a%2f%2fdominicroye.github.io%2fes%2f2018%2facceso-a-datos-de-los-rean%25C3%25A1lisis-clim%25C3%25A1ticos-desde-r%2f&amp;title=Acceso%20a%20datos%20de%20los%20rean%c3%a1lisis%20clim%c3%a1ticos%20desde%20R"
         target="_blank" rel="noopener">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https://dominicroye.github.iohttps%3a%2f%2fdominicroye.github.io%2fes%2f2018%2facceso-a-datos-de-los-rean%25C3%25A1lisis-clim%25C3%25A1ticos-desde-r%2f&amp;title=Acceso%20a%20datos%20de%20los%20rean%c3%a1lisis%20clim%c3%a1ticos%20desde%20R"
         target="_blank" rel="noopener">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Acceso%20a%20datos%20de%20los%20rean%c3%a1lisis%20clim%c3%a1ticos%20desde%20R&amp;body=https://dominicroye.github.iohttps%3a%2f%2fdominicroye.github.io%2fes%2f2018%2facceso-a-datos-de-los-rean%25C3%25A1lisis-clim%25C3%25A1ticos-desde-r%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


    <div class="article-style" itemprop="articleBody">
      <div id="TOC">
<ul>
<li><a href="#introduccion"><span class="toc-section-number">1</span> Introducción</a></li>
<li><a href="#ncep"><span class="toc-section-number">2</span> NCEP</a><ul>
<li><a href="#librerias"><span class="toc-section-number">2.1</span> Librerías</a></li>
<li><a href="#descarga-de-datos"><span class="toc-section-number">2.2</span> Descarga de datos</a></li>
<li><a href="#promedio-mensual"><span class="toc-section-number">2.3</span> Promedio mensual</a></li>
<li><a href="#visualizacion"><span class="toc-section-number">2.4</span> Visualización</a></li>
</ul></li>
<li><a href="#era-interim"><span class="toc-section-number">3</span> ERA-Interim</a><ul>
<li><a href="#instalacion"><span class="toc-section-number">3.1</span> Instalación</a></li>
<li><a href="#conexion-y-descarga-con-la-ecmwf-api"><span class="toc-section-number">3.2</span> Conexión y descarga con la ECMWF API</a></li>
<li><a href="#procesar-ncdf"><span class="toc-section-number">3.3</span> Procesar ncdf</a></li>
</ul></li>
</ul>
</div>

<p><em>Un amigo me propuso que presentara los niveles de aprendizaje de R como categorías. Una idea que ahora introduzco para cada entrada del blog. Hay tres niveles: elemental, intermedio y avanzado. Espero que ayude al lector y al usuario R.</em></p>
<hr />
<div id="introduccion" class="section level1">
<h1><span class="header-section-number">1</span> Introducción</h1>
<p>En este post enseñaré cómo podemos descargar y trabajar directamente con datos provenientes de los reanálisis climáticos en R. Se trata de sistemas de asimilación de datos que combinan modelos de pronóstico meteorológico y observaciones de distintas fuentes de forma objetiva con el fin de sintetizar el estado actual y la evolución de multiples variables de la atmósfera, la superficie de la tierra y los océanos. Los dos reanálisis más usados son <a href="https://climatedataguide.ucar.edu/climate-data/ncep-reanalysis-r2">NCEP-DO</a> (Reanalysis II) de la <em>NOAA/OAR/ESRL</em>, una versión mejorada de <em>NCEP-NCAR</em> (Reanalysis I), y <em>ERA-Interim</em> del <a href="https://www.ecmwf.int/en/research/climate-reanalysis">ECMWF</a>. Dado que <em>NCEP-DO</em> es de la primera generacióm, se recomienda usar reanálisis de tercera generación, especialmente <em>ERA-Interim</em>. Una visión general de los actuales reanálisis atmosféricos la podemos encontrar <a href="https://reanalyses.org/index.php/atmosphere/overview-current-atmospheric-reanalyses">aquí</a>. Primero vamos a ver cómo acceder a los datos del <em>NCEP</em> a través de una librería de R en <em>CRAN</em> que facilita la descarga y el manejo de los datos. Después haremos lo mismo con <em>ERA-Interim</em>, no obstante, para acceder a este último dataset de reanálisis es necesario usar <em>python</em> y la correspondiente API del <em>ECMWF</em>.</p>
</div>
<div id="ncep" class="section level1">
<h1><span class="header-section-number">2</span> NCEP</h1>
<p>Para acceder a los reanálisis del <em>NCEP</em> es necesario instalar la librería correspondiente <em>RNCEP</em>. La función principal es <code>NCEP.gather( )</code>. La resolución del reanálisis del <em>NCEP</em> es de 2,5º X 2,5º.</p>
<div id="librerias" class="section level2">
<h2><span class="header-section-number">2.1</span> Librerías</h2>
<pre class="r"><code>#instalamos las librerías RNCEP, lubridate y tidyverse
if(!require(&quot;RNCEP&quot;)) install.packages(&quot;RNCEP&quot;)
if(!require(&quot;lubridate&quot;)) install.packages(&quot;lubridate&quot;)
if(!require(&quot;tidyverse&quot;)) install.packages(&quot;tidyverse&quot;)
if(!require(&quot;sf&quot;)) install.packages(&quot;sf&quot;)

#cargamos las librerías
library(RNCEP)
library(lubridate) #la necesitamos para manipular fechas
library(tidyverse) #para visualizar y manipular 
library(RColorBrewer) #colores para la visualización
library(sf) #para importar un shapefile y trabajar con geom_sf</code></pre>
</div>
<div id="descarga-de-datos" class="section level2">
<h2><span class="header-section-number">2.2</span> Descarga de datos</h2>
<p>Descargaremos la temperatura del aire a la altura de 850haPa para el año 2016. Las variables y niveles de presión pueden ser consultados en los detalles de la función <code>?NCEP.gather</code>. El argumento <em>reanalysis2</em> nos permite descargar tanto la versión I como la versión II, siendo por defecto <em>FALSE</em>, o sea, se accede al reanálisis I. En todas las consultas obtendremos datos horarios de cada 6 horas (00:00, 06:00, 12:00 y 18:00). Esto supone un total de 1464 valores para el año 2016.</p>
<pre class="r"><code>#definimos los argumentos necesarios
month_range &lt;- c(1,12)     #período de meses
year_range &lt;- c(2016,2016) #período de años

lat_range &lt;- c(30,60)      #rango de latitud
lon_range &lt;- c(-30,50)     #rango de longitud
 

data &lt;- NCEP.gather(&quot;air&quot;,    #nombre de la variable
                    850, #altura 850hPa
                    month_range,year_range,
                    lat_range,lon_range,
                    return.units = TRUE,
                    reanalysis2=TRUE)</code></pre>
<pre><code>## [1] Units of variable &#39;air&#39; are degK
## [1] Units of variable &#39;air&#39; are degK</code></pre>
<pre class="r"><code>#dimensiones                     
dim(data) </code></pre>
<pre><code>## [1]   13   33 1464</code></pre>
<pre class="r"><code>#encontramos en dimnames( ) lon,lat y tiempo
#fechas y horas 
date_time &lt;- dimnames(data)[[3]]
date_time &lt;- ymd_h(date_time)
head(date_time)</code></pre>
<pre><code>## [1] &quot;2016-01-01 00:00:00 UTC&quot; &quot;2016-01-01 06:00:00 UTC&quot;
## [3] &quot;2016-01-01 12:00:00 UTC&quot; &quot;2016-01-01 18:00:00 UTC&quot;
## [5] &quot;2016-01-02 00:00:00 UTC&quot; &quot;2016-01-02 06:00:00 UTC&quot;</code></pre>
<pre class="r"><code>#longitud y latitud
lat &lt;- dimnames(data)[[1]]
lon &lt;- dimnames(data)[[2]]
head(lon);head(lat)</code></pre>
<pre><code>## [1] &quot;-30&quot;   &quot;-27.5&quot; &quot;-25&quot;   &quot;-22.5&quot; &quot;-20&quot;   &quot;-17.5&quot;</code></pre>
<pre><code>## [1] &quot;60&quot;   &quot;57.5&quot; &quot;55&quot;   &quot;52.5&quot; &quot;50&quot;   &quot;47.5&quot;</code></pre>
</div>
<div id="promedio-mensual" class="section level2">
<h2><span class="header-section-number">2.3</span> Promedio mensual</h2>
<p>Vemos que se trata de un <em>array</em> de tres dimensiones con [lat,lon,tiempo]. Además, extraemos latitud, longitud y el tiempo. La temperatura está dada en Kelvin. El objetivo aquí será mostrar dos mapas comparando enero y julio de 2016.</p>
<pre class="r"><code>#creamos nuestra variable de agrupación 
group &lt;- month(date_time) 

#estimamos el promedio por mes de la temperatura
data_month &lt;- aperm(
  apply(
    data, #nuestros datos
    c(1,2), #aplicamos a cada serie temporal 1:fila, 2:columna la función mean( )
    by, #agrupar por 
    group, #meses como agrupación
    function(x)ifelse(all(is.na(x)),NA,mean(x))),
  c(2,3,1)) #reordenamos para obtener un array como el original

dim(data_month) #temperatura 850haP por mes enero a diciembre</code></pre>
<pre><code>## [1] 13 33 12</code></pre>
</div>
<div id="visualizacion" class="section level2">
<h2><span class="header-section-number">2.4</span> Visualización</h2>
<p>Ahora, podemos visualizar con <em>ggplot2</em> la temperatura de enero y julio. En este ejemplo, uso <code>geom_sf( )</code> de la librería <a href="https://github.com/r-spatial/sf"><em>sf</em></a>, que hace el trabajo más fácil para visualizar en <em>ggplot</em> objetos espaciales (en el futuro haré un post sobre sf and ggplot). En la dimensión de latitud y longitud vemos que únicamente nos indica para cada fila y columna un valor. Pero necesitamos las coordenadas de todas las celdas de la matriz. Para crear todas las combinaciones entre dos variables usamos la función <code>expand.grid( )</code>.</p>
<pre class="r"><code>#primero creamos todas las combinaciones de lonlat
lonlat &lt;- expand.grid(lon=lon,lat=lat)

#lonlat es carácter, ya que fue un nombre, por eso lo convertimos en númerico
lonlat &lt;- apply(lonlat,2,as.numeric)

#lon y lat no están en el orden como lo esperamos
#fila=lon; columna=lat
data_month &lt;- aperm(data_month,c(2,1,3))

#subtraemos 273.15K para convertir K a ºC.
df &lt;- data.frame(lonlat,
                 Ta01=as.vector(data_month[,,1])-273.15,
                 Ta07=as.vector(data_month[,,7])-273.15)</code></pre>
<p>Antes de visualizar los datos con <em>ggplot2</em>, tenemos que adpatar la tabla. El shapefile con los limites de los países se puede descargar <a href="/files/CNTR_RG_03M_2014.zip">aquí</a>.</p>
<pre class="r"><code>#convertimos la tabla ancha en una larga
df &lt;- gather(df,month,Ta,Ta01:Ta07)%&gt;%
             mutate(month=factor(month,unique(month),c(&quot;Jan&quot;,&quot;Jul&quot;)))

#importamos el limite de países
limit &lt;- st_read(&quot;CNTR_RG_03M_2014.shp&quot;)</code></pre>
<pre><code>## Reading layer `CNTR_RG_03M_2014&#39; from data source `C:\Users\xeo19\Documents\GitHub\blogR\content\post\CNTR_RG_03M_2014.shp&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 256 features and 3 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -180 ymin: -90 xmax: 180 ymax: 83.66068
## epsg (SRID):    NA
## proj4string:    +proj=longlat +ellps=GRS80 +no_defs</code></pre>
<pre class="r"><code>#gama de colores
colbr &lt;- brewer.pal(11,&quot;RdBu&quot;)

ggplot(df)+
      geom_tile(aes(lon,lat,fill=Ta))+ #temperatura
      geom_sf(data=limit,fill=NA,size=.5)+ #limite
        scale_fill_gradientn(colours=rev(colbr))+
          coord_sf(ylim=c(30,60),xlim=c(-30,50))+
          scale_x_continuous(breaks=seq(-30,50,10),expand=c(0,0))+
          scale_y_continuous(breaks=seq(30,60,5),expand=c(0,0))+
          labs(x=&quot;&quot;,y=&quot;&quot;,fill=&quot;Ta 850hPa (ºC)&quot;)+
           facet_grid(month~.)+ #mapa por mes
             theme_bw()</code></pre>
<p><img src="/post/2018-09-15-acceso-a-datos-de-los-reanalisis-desde-r.es_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
</div>
<div id="era-interim" class="section level1">
<h1><span class="header-section-number">3</span> ERA-Interim</h1>
<p>El <em>ECMWF</em> ofrece acceso a sus bases de datos públicos a partir de una <a href="https://confluence.ecmwf.int//display/WEBAPI/Access+ECMWF+Public+Datasets"><em>pyhton-API</em></a>. Es necesario estar registrado en la web del <em>ECMWF</em>. Se puede darse de alta <a href="https://apps.ecmwf.int/registration/">aquí</a>. Al tratarse de otro lenguaje de programación, en R debemos usar un interfaz entre ambos lo que nos permite la librería <a href="https://github.com/rstudio/reticulate"><em>reticulate</em></a>. También debemos que tener instalada una distribución de pyhton (versión 2.x o 3.x). En el caso de Windows podemos usar <a href="https://www.anaconda.com/download/">anaconda</a>.</p>
<div id="instalacion" class="section level2">
<h2><span class="header-section-number">3.1</span> Instalación</h2>
<pre class="r"><code>if(!require(&quot;reticulate&quot;)) install.packages(&quot;reticulate&quot;)
if(!require(&quot;ncdf4&quot;)) install.packages(&quot;ncdf4&quot;) #para manejar formato netCDF

#cargamos las librerías
library(reticulate)
library(ncdf4)</code></pre>
<p>Una vez que tenemos instalado <em>anaconda</em> y la librería <em>reticulate</em>, podemos instalar la librería <em>python ecmwfapi</em>. La instalación la podemos llevar a cabo, o bien através del CMD de Windows usando el comando <em>conda install -c conda-forge ecmwf-api-client</em>, o bien con la función <code>py_install( )</code> de la librería <em>reticulate</em>. La misma función permite instalar cualquier librería <em>python</em> desde R.</p>
<pre class="r"><code>#instalamos la API ECMWF
py_install(&quot;ecmwf-api-client&quot;)</code></pre>
<pre><code>## 
## Installation complete.</code></pre>
</div>
<div id="conexion-y-descarga-con-la-ecmwf-api" class="section level2">
<h2><span class="header-section-number">3.2</span> Conexión y descarga con la ECMWF API</h2>
<p>Para poder acceder a la API es requisito crear un archivo con la información del usuario.</p>
<p>El archivo “.ecmwfapirc” debe contener la siguiente información:</p>
<pre><code>{
    &quot;url&quot;   : &quot;https://api.ecmwf.int/v1&quot;,
    &quot;key&quot;   : &quot;XXXXXXXXXXXXXXXXXXXXXX&quot;,
    &quot;email&quot; : &quot;john.smith@example.com&quot;
}</code></pre>
<p>La clave podemos obtenerla con la cuenta de usuario <a href="https://api.ecmwf.int/v1/key/">aquí</a>.</p>
<p>El archivo se puede crear con el bloc de notas de Windows.</p>
<ol style="list-style-type: decimal">
<li>Creamos un documento “ecmwfapirc.txt”.</li>
<li>Renombramos este archivo a “.ecmwfapirc.”</li>
</ol>
<p>El último punto desaparece de forma automática. Después guardamos este archivo en “C:/USERNAME/.ecmwfapirc” o “C:/USERNAME/Documents/.ecmwfapirc”.</p>
<pre class="r"><code>#importamos la librería python ecmwfapi
ecmwf &lt;- import(&#39;ecmwfapi&#39;)

#en este paso debe existir el archivo .ecmwfapirc
server = ecmwf$ECMWFDataServer() #iniciamos la conexión</code></pre>
<p>Llegados a este punto, ¿cómo creamos una consulta? Lo más fácil es ir a la web del <a href="http://apps.ecmwf.int/datasets/data/interim-full-daily/levtype=sfc/"><em>ECMWF</em></a> dónde elegimos la base de datos, en este caso <em>ERA-Interim</em> en superficie, para crear un script con todos los datos necesarios. Más detalles sobre la sintaxis podemos encontrar <a href="https://confluence.ecmwf.int/display/WEBAPI/Brief+request+syntax">aquí</a>. Cuando procedemos en la web sólamente tenemos que hacer click en “View MARS Request”. Este paso nos lleva al script en <em>python</em>.</p>
<div class="figure">
<img src="/img/erainterim1.png" />

</div>
<div class="figure">
<img src="/img/erainterim2.png" />

</div>
<p>Con la sintaxis del script que nos da la <em>MARS Request</em> podemos crear la consulta en R.</p>
<pre class="r"><code>#creamos la consulta
query &lt;-r_to_py(list(
  class=&#39;ei&#39;,
  dataset= &quot;interim&quot;, #base de datos
  date= &quot;2017-01-01/to/2017-12-31&quot;, #periodo 
  expver= &quot;1&quot;,
  grid= &quot;0.125/0.125&quot;, #resolución
  levtype=&quot;sfc&quot;,
  param= &quot;167.128&quot;, # temperatura del aire (2m)
  area=&quot;45/-10/30/5&quot;, #N/W/S/E
  step= &quot;0&quot;,
  stream=&quot;oper&quot;,
  time=&quot;00:00:00/06:00:00/12:00:00/18:00:00&quot;, #paso de tiempo
  type=&quot;an&quot;,
  format= &quot;netcdf&quot;, #formato
  target=&#39;ta2017.nc&#39; #nombre del archivo
))

server$retrieve(query)</code></pre>
<p>El resultado es un archivo netCDF que podemos processar con la librería <em>ncdf4</em>.</p>
</div>
<div id="procesar-ncdf" class="section level2">
<h2><span class="header-section-number">3.3</span> Procesar ncdf</h2>
<p>A partir de aquí, el objetivo será la extracción de una serie temporal de una coordenada más próxima a una dada. Usaremos las coordenadas de Madrid (40.418889, -3.691944).</p>
<pre class="r"><code>#cargamos las librerías 
library(sf)
library(ncdf4)
library(tidyverse)</code></pre>
<pre class="r"><code>#abrimos la conexión con el archivo
nc &lt;- nc_open(&quot;ta2017.nc&quot;)

#extraemos lon y lat
lat &lt;- ncvar_get(nc,&#39;latitude&#39;)
lon &lt;- ncvar_get(nc,&#39;longitude&#39;)
dim(lat);dim(lon)</code></pre>
<pre><code>## [1] 121</code></pre>
<pre><code>## [1] 121</code></pre>
<pre class="r"><code>#extraemos el tiempo
t &lt;- ncvar_get(nc, &quot;time&quot;)

#unidad del tiempo: horas desde 1900-01-01
ncatt_get(nc,&#39;time&#39;)</code></pre>
<pre><code>## $units
## [1] &quot;hours since 1900-01-01 00:00:0.0&quot;
## 
## $long_name
## [1] &quot;time&quot;
## 
## $calendar
## [1] &quot;gregorian&quot;</code></pre>
<pre class="r"><code>#convertimos las horas en fecha+hora 
#as_datetime de lubridate espera segundos
timestamp &lt;- as_datetime(c(t*60*60),origin=&quot;1900-01-01&quot;)

#importamos los datos
data &lt;- ncvar_get(nc,&quot;t2m&quot;)

#cerramos la conexión
nc_close(nc)</code></pre>
<p>Más detalles se pueden consultar en este breve manual sobre cómo trabajar con netCDF <a href="https://dominicroye.github.io/en/publication/ncdf_2015/">aqui</a>. En esta próxima sección hacemos uso de la librería <em>sf</em> la cuál está sustituyendo las más conocidas <em>sp</em> y <em>rgdal</em>.</p>
<pre class="r"><code>#creamos todas las combinaciones
lonlat &lt;- expand.grid(lon=lon,lat=lat)

#debemos convertir las coordenadas en objeto espacial sf
#además indicamos el sistema de coordenadas en codigo EPSG
coord &lt;- st_as_sf(lonlat,coords=c(&quot;lon&quot;,&quot;lat&quot;))%&gt;%
                    st_set_crs(4326)

#lo mismo hacemos con nuestra coordenada de Madrid
psj &lt;- st_point(c(-3.691944,40.418889))%&gt;%
                   st_sfc()%&gt;%
                     st_set_crs(4326)

#plot de los puntos
plot(st_geometry(coord))
plot(psj,add=TRUE,pch = 3, col = &#39;red&#39;)</code></pre>
<p><img src="/post/2018-09-15-acceso-a-datos-de-los-reanalisis-desde-r.es_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>En los próximos pasos calculamos la distancia de nuestro punto de referencia a todos los puntos del grid. Posteriormente, buscamos aquel con menos distancia.</p>
<pre class="r"><code>#añadimos la distancia a los puntos
coord &lt;- mutate(coord,dist=st_distance(coord,psj))

#creamos una matrix de distancia con las mismas dimensiones que nuestros datos
dist_mat &lt;- matrix(coord$dist,dim(data)[-3])

#la función arrayInd es útil para obtener los índices fila y columna en este caso
mat_index &lt;- as.vector(arrayInd(which.min(dist_mat), dim(dist_mat)))

#extraemos la serie temporal y cambiamos la unidad de K a ºC
#convertimos el tiempo en fecha + hora
df &lt;- data.frame(ta=data[mat_index[1],mat_index[2],],time=timestamp)%&gt;%
        mutate(ta=ta-273.15,time=ymd_hms(time))</code></pre>
<p>Para terminar, visualizamos nuestra serie temporal.</p>
<pre class="r"><code>ggplot(df,
       aes(time,ta))+
    geom_line()+
    labs(y=&quot;Temperatura (ºC)&quot;,
             x=&quot;&quot;)+
    theme_bw()</code></pre>
<p><img src="/post/2018-09-15-acceso-a-datos-de-los-reanalisis-desde-r.es_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
</div>
</div>

    </div>

    


<div class="article-tags">
  
  <a class="label label-default" href="https://dominicroye.github.io/es/tags/reanalisis/">reanalisis</a>
  
  <a class="label label-default" href="https://dominicroye.github.io/es/tags/interim/">interim</a>
  
  <a class="label label-default" href="https://dominicroye.github.io/es/tags/ncep/ncar/">NCEP/NCAR</a>
  
  <a class="label label-default" href="https://dominicroye.github.io/es/tags/era/">era</a>
  
  <a class="label label-default" href="https://dominicroye.github.io/es/tags/descarga/">descarga</a>
  
  <a class="label label-default" href="https://dominicroye.github.io/es/tags/ncdf/">ncdf</a>
  
  <a class="label label-default" href="https://dominicroye.github.io/es/tags/acceso/">acceso</a>
  
  <a class="label label-default" href="https://dominicroye.github.io/es/tags/api/">api</a>
  
  <a class="label label-default" href="https://dominicroye.github.io/es/tags/python/">python</a>
  
  <a class="label label-default" href="https://dominicroye.github.io/es/tags/ecmwf/">ECMWF</a>
  
</div>




    
    

    
    <div class="article-widget">
      <div class="post-nav">
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Anterior</div>
    <a href="https://dominicroye.github.io/es/2018/el-gr%C3%A1fico-de-tarta/" rel="prev">El gráfico de tarta</a>
  </div>
  
</div>

    </div>
    

    
<section id="comments">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-dominicroye-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



  </div>
</article>

<footer class="site-footer">
  <div class="container">

    

    <p class="powered-by">

      &copy; 2018 Dominic Royé. All rights reserved. &middot; 

      Powered by the
      <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
      <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close btn-large" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Citar</h4>
      </div>
      <div>
        <pre><code class="modal-body tex"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary btn-outline js-copy-cite" href="#" target="_blank">
          <i class="fa fa-copy"></i> Copiar
        </a>
        <a class="btn btn-primary btn-outline js-download-cite" href="#" target="_blank">
          <i class="fa fa-download"></i> Descargar
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha512-3P8rXCuGJdNZOnUx/03c1jOTnMn3rP63nBip5gOP2qmUh5YAdVAvFZ1E+QLZZbC1rtMrQb+mah3AfYW11RUrWA==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
        
      

      
      
    

    <script src="/js/hugo-academic.js"></script>
    

    
    

    
    
    
    <script id="dsq-count-scr" src="//https-dominicroye-github-io.disqus.com/count.js" async></script>
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/search.json";
      const i18n = {
        'placeholder': "Search...",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Proyectos",
        'publication' : "Publicaciones",
        'talk' : "Conferencias"
        };
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    <script src="/js/search.js"></script>
    

    
    

  </body>
</html>

