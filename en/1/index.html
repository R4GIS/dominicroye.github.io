<div id="la-base-de-datos-de-open-street-maps" class="section level2">
<h2>La base de datos de Open Street Maps</h2>
<p>Recently I created a map of the distribution of gas stations and electric charging stations in Europe.</p>
HAHAHUGOSHORTCODE-0xc042e10580-1-HBHB
<p>How can you obtain this data?</p>
<p>Well, in this case I used points of interest (POIs) from the database of <em>Open Street Maps</em> (OSM). Obviously OSM not only contains the streets and highways, but also information that can be useful when we use a map such as locations of hospitals or gas stations. To avoid downloading the entire OSM and extracting the required information, you can use an <em>overpass API</em>, which allows us to query the OSM database with our own criteria.</p>
<p>An easy way to access an <em>overpass API</em> is through <a href="http://overpass-turbo.eu">overpass-turbo.eu</a>, which even includes a wizard to build a query and display the results on a interactive map. A detailed explanation of the previous page can be found <a href="https://wiki.openstreetmap.org/wiki/ES:Overpass_turbo">here</a>. However, we have at our disposal a package <em>osmdata</em> that allows us to create and make queries directly from the R environment. Nevertheless, the use of the <em>overpass-turbo.eu</em> can be useful when we are not sure what we are looking for or when we have some difficulty in building the query.</p>
</div>
<div id="accessing-the-overpass-api-from-r" class="section level2">
<h2>Accessing the overpass API from R</h2>
<p>The first step is to install several packages, in case they are not installed. In almost all my scripts I use <a href="https://www.tidyverse.org/"><em>tidyverse</em></a> which is a fundamental collection of different packages, including <em>dplyr</em> (data manipulation), <em>ggplot2</em> (visualization), etc. The <a href="https://r-spatial.github.io/sf/articles/sf1.html"><em>sf</em></a> package is the new standard for working with spatial data and is compatible with <em>ggplot2</em> and <em>dplyr</em>. Finally, <a href="http://stat405.had.co.nz/ggmap.pdf"><em>ggmap</em></a> makes it easier for us to create maps.</p>
<pre class="r"><code>#install the osmdata, sf, tidyverse and ggmap package
if(!require(&quot;osmdata&quot;)) install.packages(&quot;osmdata&quot;)
if(!require(&quot;tidyverse&quot;)) install.packages(&quot;tidyverse&quot;)
if(!require(&quot;sf&quot;)) install.packages(&quot;sf&quot;)
if(!require(&quot;ggmap&quot;)) install.packages(&quot;ggmap&quot;)

#load packages
library(tidyverse)
library(osmdata)
library(sf)
library(ggmap)</code></pre>
</div>
<div id="build-a-query" class="section level2">
<h2>Build a query</h2>
<p>Before creating a query, we need to know what we can filter. The <code>available_features( )</code> function returns a list of available OSM features that have different tags. More details are available in the OSM <em>wiki</em> <a href="https://wiki.openstreetmap.org/wiki/Map_Features">here</a>. For example, the feature <em>shop</em> contains as several tags among others <em>supermarket</em>, <em>fishing</em>, <em>books</em>, etc.</p>
<pre class="r"><code>#the first five features
head(available_features())</code></pre>
<pre><code>## [1] &quot;4wd only&quot;  &quot;abandoned&quot; &quot;abutters&quot;  &quot;access&quot;    &quot;addr&quot;      &quot;addr:city&quot;</code></pre>
<pre class="r"><code>#amenities
head(available_tags(&quot;amenity&quot;))</code></pre>
<pre><code>## [1] &quot;animal boarding&quot; &quot;animal shelter&quot;  &quot;archive&quot;         &quot;arts centre&quot;    
## [5] &quot;atm&quot;             &quot;baby hatch&quot;</code></pre>
<pre class="r"><code>#shops
head(available_tags(&quot;shop&quot;))</code></pre>
<pre><code>## [1] &quot;agrarian&quot;  &quot;alcohol&quot;   &quot;anime&quot;     &quot;antiques&quot;  &quot;appliance&quot; &quot;art&quot;</code></pre>
<div id="the-first-query-where-can-we-find-cinemas-in-madrid" class="section level3">
<h3>The first query: Where can we find cinemas in Madrid?</h3>
<p>To build the query, we use the <em>pipe operator</em> <code>%&gt;%</code>, which helps to chain several functions without assigning the result to a new object. Its use is very extended especially with the <em>tidyverse</em> collection of packages. If you want to know more about its use, <a href="https://www.datacamp.com/community/tutorials/pipe-r-tutorial">here</a> you have a tutorial.</p>
<p>In the first part of the query we need to indicate the place where we want to extract the information. The <code>getbb( )</code> function creates a boundering box for a given place, looking for the name. The main function is <code>opq( )</code> which build the final query. We add our filter criteria with the <code>add_osm_feature( )</code> function. In this first query we will look for cinemas in Madrid. Thatâ€™s why we use as key <em>amenity</em> and as a tag <em>cinema</em>. There are several formats to obtain the resulting spatial data of the query. The <code>osmdata_*( )</code> function sends the query to the server and, depending on the suffix * sf/sp/xml, returns a <em>simple feature</em>, <em>spatial</em> or <em>XML</em> format.</p>
<pre class="r"><code>#building the query
q &lt;- getbb(&quot;Madrid&quot;)%&gt;%
      opq()%&gt;%
       add_osm_feature(&quot;amenity&quot;, &quot;cinema&quot;)

str(q) #query structure</code></pre>
<pre><code>## List of 4
##  $ bbox    : chr &quot;40.3119774,-3.8889539,40.6437293,-3.5179163&quot;
##  $ prefix  : chr &quot;[out:xml][timeout:25];\n(\n&quot;
##  $ suffix  : chr &quot;);\n(._;&gt;;);\nout body;&quot;
##  $ features: chr &quot; [\&quot;amenity\&quot;=\&quot;cinema\&quot;]&quot;
##  - attr(*, &quot;class&quot;)= chr [1:2] &quot;list&quot; &quot;overpass_query&quot;</code></pre>
<pre class="r"><code>cinema &lt;- osmdata_sf(q)
cinema</code></pre>
<pre><code>## Object of class &#39;osmdata&#39; with:
##                  $bbox : 40.3119774,-3.8889539,40.6437293,-3.5179163
##         $overpass_call : The call submitted to the overpass API
##             $timestamp : [ do\. 1 nov\. 2018 12:25:14 ]
##            $osm_points : &#39;sf&#39; Simple Features Collection with 222 points
##             $osm_lines : &#39;sf&#39; Simple Features Collection with 0 linestrings
##          $osm_polygons : &#39;sf&#39; Simple Features Collection with 14 polygons
##        $osm_multilines : &#39;sf&#39; Simple Features Collection with 0 multilinestrings
##     $osm_multipolygons : &#39;sf&#39; Simple Features Collection with 0 multipolygons</code></pre>
<p>We see that the result is a list of different spatial objects. In our case, we would only be interested in <em>osm_points</em>.</p>
<p>How can we visulise these points?</p>
<p>The advantage of <em>sf</em> objects is that for <em>ggplot2</em> there already exists a geometry function <code>geom_sf( )</code>. Furthermore, we can include a background map using <em>ggmap</em>. The <code>get_map( )</code> function downloads the map for a given place. Alternatively, it can be an address, latitude/longitude or a bounding box. The <em>maptype</em> argument allows us to indicate the style or type of map. You can find more details in the help of the <code>?get_map</code> function.</p>
<p>When we build a graph with <em>ggplot</em> we usually start with <code>ggplot( )</code>. In this case, we start with <em>ggmap( )</em> that includes the object with our background map. Then we add with <code>geom_sf( )</code> the points of the cinemas in Madrid. It is important to indicate with the argument <em>inherit.aes = FALSE</em> that you it has to use the <em>aesthetic mappings</em> of the spatial object <em>osm_points</em>. In addition, we change the color, fill, transparency (<em>alpha</em>), type and size of the circle.</p>
<pre class="r"><code>#our background map
mad_map &lt;- get_map(getbb(&quot;Madrid&quot;),maptype = &quot;toner-background&quot;)

#final map
ggmap(mad_map)+
  geom_sf(data=cinema$osm_points,
          inherit.aes =FALSE,
          colour=&quot;#238443&quot;,
          fill=&quot;#004529&quot;,
          alpha=.5,
          size=4,
          shape=21)+
  labs(x=&quot;&quot;,y=&quot;&quot;)</code></pre>
<p><img src="2018-11-03-accessing-osm-data-with-r.en..Rmd_files/figure-html/fig.width==5-1.png" width="672" /></p>
</div>
<div id="where-we-can-find-mercadona-supermarkets" class="section level3">
<h3>Where we can find Mercadona supermarkets?</h3>
<p>Instead of obtaining a bounding box with the function <em>getbb( )</em> we can build our own box. To do this, we create a matrix of two columns, the order here has to be East/West/South/North. In the query we use two features: <em>name</em> and <em>shop</em> to filter supermarkets that are of this particular brand. Depending on the area or volume of the query, it is necessary to extend the waiting time. By default, they are 25 seconds (<em>timeout</em>).</p>
<p>The map we create in this case consists only of the supermarket points. Therefore, we use the usual grammar by adding the geometry <code>geom_sf( )</code>. The <code>theme_void( )</code> function removes everything except for the points. By default, the object <em>sf</em> in <em>ggplot</em> creates reticles that can be removed using the <code>coord_sf( )</code> function with the argument <em>datum = NA</em>.</p>
<pre class="r"><code>#bounding box for the Iberian Peninsula
m &lt;- matrix(c(-10,5,30,46),ncol=2,byrow=TRUE)
row.names(m) &lt;- c(&quot;x&quot;,&quot;y&quot;)
names(m) &lt;- c(&quot;min&quot;,&quot;max&quot;)

#building the query
q &lt;- m %&gt;% 
      opq (timeout=25*100) %&gt;%
         add_osm_feature(&quot;name&quot;,&quot;Mercadona&quot;)%&gt;%
         add_osm_feature(&quot;shop&quot;,&quot;supermarket&quot;)

#query
mercadona &lt;- osmdata_sf(q)

#final map
ggplot(mercadona$osm_points)+
  geom_sf(colour=&quot;#08519c&quot;,
          fill=&quot;#08306b&quot;,
          alpha=.5,
          size=1,
          shape=21)+
  coord_sf(datum=NA)+
  theme_void()</code></pre>
<p><img src="2018-11-03-accessing-osm-data-with-r.en..Rmd_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
</div>
